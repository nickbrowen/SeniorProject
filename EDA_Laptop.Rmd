---
title: "EDA Laptop"
output: html_notebook
---

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(scales)
library(tidytext)
library(lubridate)
library(stringr)
library(purrr)
library(curl)
```

#For Desktop
```{r}
tweets <- read.csv("tweets_te.csv")
tweets <- as_tibble(tweets)
tweets <- tweets %>% mutate(external_author_id = as.character(external_author_id), 
                             author = as.character(author),
                             word = as.character(word),
                             token = as.character(token),
                             emoji = as.character(emoji),
                             region = as.character(region),
                             language = as.character(language),
                             account_type = as.character(account_type),
                             account_category = as.character(account_category),
                             publish_date = ymd_hms(publish_date),
                             harvested_date = ymd_hms(harvested_date),
                             emoji_bin = ifelse(is.na(emoji),"Word", "Emoji"))
```


```{r}
tweets_te_subset <- sample_n(tweets, dim(tweets)[1]*0.05)
write.csv(tweets_te_subset, "tweets_te_subset.csv")
```

```{r}
tweets_subset <- read.csv("tweets_te_subset.csv")
```


#For Laptop
```{r}
tweets <- read.csv("tweets_te_subset.csv")
tweets <- as_tibble(tweets)
tweets <- tweets %>% mutate(external_author_id = as.character(external_author_id), 
                             author = as.character(author),
                             word = as.character(word),
                             token = as.character(token),
                             emoji = as.character(emoji),
                             region = as.character(region),
                             language = as.character(language),
                             account_type = as.character(account_type),
                             account_category = as.character(account_category),
                             publish_date = ymd_hms(publish_date),
                             harvested_date = ymd_hms(harvested_date),
                             emoji_bin = ifelse(is.na(emoji),"Word", "Emoji"))

```



##EDA

```{r message=FALSE, paged.print=FALSE}
tweets %>% count(token, sort = T) %>% top_n(20) %>% 
           mutate(token = reorder(token, n)) %>%
           ggplot(aes(token,n)) + geom_col() + coord_flip() +
           ggtitle("Top Words and Emojis in All Tweets") + scale_y_continuous(labels = comma)
```

```{r message=FALSE, paged.print=FALSE}
tweets %>% group_by(emoji_bin) %>%
           count(token, sort = T) %>% top_n(20) %>% ungroup() %>%
           mutate(token = reorder(token, n)) %>%
           ggplot(aes(token,n, emoji_bin)) + geom_col() + coord_flip() +
           facet_wrap(~emoji_bin, scales = "free") +
           ggtitle("Top Words and Emojis in All Tweets") + scale_y_continuous(labels = comma)
```


```{r}
tweets %>% filter(token == "workout") %>% group_by(account_category) %>% count(token, sort = T)
```

Initially, it was odd to see the word "workout" as the second most used word. Then upon investigation, this word was used almost exclusively in the Commercial account category. This makes me question if I should filter out tweets from the category, because they might not be useful to my research questions.


```{r}
tweets %>% group_by(account_category) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  mutate(account_category = reorder(account_category, n)) %>%
  ggplot(aes(account_category, n)) + geom_col() + coord_flip() + ggtitle("Number of Words and Emojis by Account   Category") + scale_y_continuous(labels = comma)
```



```{r}
reorder_within <- function(x, by, within, fun = mean, sep = "___", ...) {
  new_x <- paste(x, within, sep = sep)
  stats::reorder(new_x, by, FUN = fun)
}

scale_x_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_x_discrete(labels = function(x) gsub(reg, "", x), ...)
}

```

```{r}
tweets %>% filter(account_category %in% c("RightTroll", "LeftTroll", "NewsFeed", "HashtagGamer")) %>%
     group_by(account_category) %>% count(token) %>% 
     top_n(10) %>%
     ungroup() %>%
     ggplot(aes(reorder_within(token, n, account_category),n, fill = account_category)) + 
     geom_col(show.legend = F) + coord_flip() + scale_x_reordered() +
     facet_wrap(~account_category, ncol = 2, scales = "free") + labs(x = "token")
     ggtitle("Top Words and Emojis in Each Account Category")
```

```{r}
tweets %>% filter(!account_category %in% c("RightTroll", "LeftTroll", "NewsFeed", "HashtagGamer")) %>%
     group_by(account_category) %>% count(token) %>% 
     top_n(10) %>%
     ungroup() %>%
     ggplot(aes(reorder_within(token, n, account_category),n, fill = account_category)) + 
     geom_col(show.legend = F) + coord_flip() + scale_x_reordered() +
     facet_wrap(~account_category, ncol = 2, scales = "free") + labs(x = "token")
     ggtitle("Top Words and Emojis in Each Account Category")
```

Looking at the top words for Commercial, I see the words mainly have to do with some weight loss program, and also "stocks" are in the top 10. Also, NonEnglish seems unuseful. LeftTroll and RightTroll clearly have a political focus. NewFeed contains top words like "trump" and "politics". While FearMonger focuses on an event with Kochfarms (which itself might have political meaning as people associate it with the Democratic donors the Koch brothers),  there is also a top word of "demndebate". HashtagGamer also has "trump" as a top word. Unknown could be useful or not, as it has no clear theme but does contain a reference to Hillary Clinton in one of its top words.  I'll consider focusing on the categories RightTroll, LeftTroll, NewsFeed, Fearmonger, HashtagGamer, and possibly Unknown.

Note - used drlib/R/reorder_within.R for the reorder_within and scale_x_reordered functions   
   
   
```{r}
tweets %>% group_by(account_category, tweet_id) %>% 
  count(account_category, sort =T)  %>% group_by(account_category) %>%
  summarise(n = n()) %>% mutate(account_category = reorder(account_category, n)) %>%
  ggplot(aes(account_category, n)) + geom_col() + coord_flip() + ggtitle("Number of Tweets by Account Category") + 
  scale_y_continuous(labels = comma)
```



```{r message=FALSE, paged.print=FALSE}
tweets %>% filter(!account_category %in% c("Commercial", "NonEnglish")) %>%
           count(token, sort = T) %>% top_n(20) %>% 
           mutate(token = reorder(token, n)) %>%
           ggplot(aes(token,n)) + geom_col() + coord_flip() +
           ggtitle("Top Words and Emojis in RightTroll, Newsfeed, HashtagGamer, Fearmonger, Unknown")
```


```{r}
tweets %>% filter(account_category %in% c("RightTroll", "LeftTroll", "NewsFeed", "HashtagGamer"),  
                              emoji_bin=="Emoji") %>%
     group_by(account_category) %>% count(token) %>% 
     top_n(5) %>%
     ungroup() %>%
     ggplot(aes(reorder_within(token, n, account_category),n, fill = account_category)) + 
     geom_col(show.legend = F) + coord_flip() + scale_x_reordered() +
     facet_wrap(~account_category, ncol = 2, scales = "free_y")
```
First, LeftTroll and RightTroll use much more emojis than HashtagGamer or NewsFeed. All four types use the REDHEART emoji the most. We can see that the left troll uses the RAISEDFIST emoji very frequently, which makes sense as it has connections to black history.



```{r}
tweets %>% distinct(tweet_id, .keep_all = T) %>% 
  group_by(date = date(publish_date)) %>% 
  filter(date >= as.Date("2014-06-01")) %>% count(date) %>% 
  ungroup() %>% 
  ggplot(aes(date, n)) + geom_line() + theme_minimal() +
    geom_vline(xintercept = as.Date("2016-11-08"), colour = "red", size = 1, linetype =4) +
    geom_text(aes(x=as.Date("2016-11-08"),y = 3000), label = "Election Day", size=3, angle=0, vjust=0,  
              hjust=-0.1,  colour = "red")
```


```{r}
tweets %>% distinct(tweet_id, .keep_all = T) %>% 
  filter(account_category %in% c("RightTroll", "LeftTroll", "NewsFeed", "HashtagGamer")) %>%
  group_by(account_category, date = date(publish_date)) %>% 
  filter(date >= as.Date("2014-06-01")) %>% count(date) %>% 
  ungroup() %>% 
  ggplot(aes(date, n, colour= account_category)) + geom_line() + theme_minimal() +
    geom_vline(xintercept = as.Date("2016-11-08"), colour = "red", size = 1, linetype =4) +
    geom_text(aes(x=as.Date("2016-11-08"),y = 3000), label = "Election Day", size=3, angle=0, 
              vjust=0,  hjust=-0.1,  colour = "red")
```